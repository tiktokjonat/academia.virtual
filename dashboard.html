<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Geincos Admin | Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { 
            --primary: #4f46e5; 
            --bg-body: #f3f4f6; 
            --surface: #ffffff; 
            --text-main: #1e293b; 
            --text-muted: #64748b; 
            --success: #10b981; 
            --danger: #ef4444; 
            --warning: #f59e0b; 
            --border: #e2e8f0; 
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg-body); color: var(--text-main); display: flex; height: 100vh; overflow: hidden; }
        
        /* SIDEBAR (Idéntico a panel-admin) */
        .sidebar { width: 260px; background: var(--surface); border-right: 1px solid var(--border); padding: 24px; display: flex; flex-direction: column; z-index: 50; flex-shrink: 0; }
        .brand { display: flex; align-items: center; gap: 12px; margin-bottom: 40px; }
        .brand i { font-size: 1.5rem; color: var(--primary); } 
        .brand span { font-size: 1.25rem; font-weight: 800; }
        .menu-label { font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); font-weight: 700; margin: 20px 0 10px 10px; }
        .menu-item { padding: 12px 16px; color: var(--text-muted); border-radius: 8px; cursor: pointer; margin-bottom: 4px; font-weight: 500; display: flex; align-items: center; gap: 12px; transition: 0.2s; text-decoration: none; position: relative; }
        .menu-item:hover { background: #eef2ff; color: var(--primary); }
        .menu-item.active { background: var(--primary); color: white; }

        /* MAIN CONTENT */
        .main-content { flex: 1; padding: 32px; overflow-y: auto; display: flex; flex-direction: column; }
        .header { margin-bottom: 30px; }
        h2 { font-size: 1.8rem; font-weight: 700; margin-bottom: 5px; }
        p.subtitle { color: var(--text-muted); }

        /* KPI CARDS */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: var(--surface); padding: 25px; border-radius: 16px; border: 1px solid var(--border); display: flex; align-items: center; gap: 20px; transition: transform 0.2s; }
        .kpi-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        .kpi-icon { width: 60px; height: 60px; border-radius: 12px; display: flex; justify-content: center; align-items: center; font-size: 1.8rem; }
        .icon-blue { background: #e0e7ff; color: var(--primary); }
        .icon-green { background: #dcfce7; color: var(--success); }
        .icon-orange { background: #ffedd5; color: var(--warning); }
        .icon-red { background: #fee2e2; color: var(--danger); }
        
        .kpi-info h4 { color: var(--text-muted); font-size: 0.9rem; font-weight: 600; text-transform: uppercase; margin-bottom: 5px; }
        .kpi-info h2 { font-size: 2rem; font-weight: 800; line-height: 1; color: var(--text-main); }

        /* CHARTS SECTION */
        .charts-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px; }
        .chart-card { background: var(--surface); padding: 25px; border-radius: 16px; border: 1px solid var(--border); height: 400px; display: flex; flex-direction: column; }
        .chart-header { margin-bottom: 20px; font-weight: 700; font-size: 1.1rem; }
        .chart-body { flex: 1; position: relative; }

        /* RECENT ACTIVITY TABLE */
        .recent-table { background: var(--surface); border-radius: 16px; border: 1px solid var(--border); overflow: hidden; }
        .recent-header { padding: 20px 25px; border-bottom: 1px solid var(--border); font-weight: 700; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px 25px; background: #f8fafc; font-size: 0.85rem; color: var(--text-muted); }
        td { padding: 15px 25px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; }
        .badge-success { background: #dcfce7; color: #166534; }
        .badge-warning { background: #ffedd5; color: #9a3412; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="brand"><i class="fas fa-cube"></i><span>Geincos Admin</span></div>
        <div class="menu-label">Analítica</div>
        <div class="menu-item active"><i class="fas fa-chart-pie"></i> Dashboard</div>
        <a href="panel-admin.html" class="menu-item"><i class="fas fa-arrow-left"></i> Volver al Panel</a>
        
        <div class="menu-label">Accesos Rápidos</div>
        <a href="panel-admin.html" class="menu-item"><i class="fas fa-users"></i> Usuarios</a>
        <a href="panel-admin.html" class="menu-item"><i class="fas fa-robot"></i> IA Roleplay</a>
        
        <div class="menu-item" style="margin-top:auto; color:var(--danger)" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
        </div>
    </div>

    <div class="main-content">
        <div class="header">
            <h2>Dashboard General</h2>
            <p class="subtitle">Resumen de rendimiento en tiempo real</p>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-icon icon-blue"><i class="fas fa-user-graduate"></i></div>
                <div class="kpi-info"><h4>Alumnos</h4><h2 id="kpiUsers">0</h2></div>
            </div>
            <div class="kpi-card">
                <div class="kpi-icon icon-green"><i class="fas fa-clipboard-check"></i></div>
                <div class="kpi-info"><h4>Exámenes</h4><h2 id="kpiEvals">0</h2></div>
            </div>
            <div class="kpi-card">
                <div class="kpi-icon icon-orange"><i class="fas fa-star"></i></div>
                <div class="kpi-info"><h4>Promedio Global</h4><h2 id="kpiAvg">0.0</h2></div>
            </div>
            <div class="kpi-card">
                <div class="kpi-icon icon-red"><i class="fas fa-robot"></i></div>
                <div class="kpi-info"><h4>Escenarios IA</h4><h2 id="kpiIA">0</h2></div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-header">Rendimiento por Grupos</div>
                <div class="chart-body"><canvas id="barChart"></canvas></div>
            </div>
            <div class="chart-card">
                <div class="chart-header">Tasa de Aprobación</div>
                <div class="chart-body"><canvas id="doughnutChart"></canvas></div>
            </div>
        </div>

        <div class="recent-table">
            <div class="recent-header">Últimas Evaluaciones Realizadas</div>
            <table>
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Usuario</th>
                        <th>Curso</th>
                        <th>Nota</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody id="recentActivity">
                    <tr><td colspan="5" style="text-align:center">Cargando...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const SB_URL = 'https://xgvfcmadsprjyljtpooo.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhndmZjbWFkc3ByanlsanRwb29vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1ODMxNjAsImV4cCI6MjA4MjE1OTE2MH0.XYBbKFE17PfyYMn2SNL5UJrCQmDRbimTQO0jpbX1Zd0';
        const sbClient = supabase.createClient(SB_URL, SB_KEY);

        window.onload = initDashboard;

        function logout() { localStorage.clear(); window.location.href='index.html'; }

        async function initDashboard() {
            // 1. Cargar contadores simples
            const { count: usersCount } = await sbClient.from('usuarios').select('*', { count: 'exact', head: true }).neq('rol', 'admin');
            const { count: evalsCount } = await sbClient.from('evaluaciones').select('*', { count: 'exact', head: true });
            const { count: iaCount } = await sbClient.from('roleplay_scenarios').select('*', { count: 'exact', head: true });
            
            // Promedio General
            const { data: grades } = await sbClient.from('evaluaciones').select('nota');
            let avg = 0;
            if (grades && grades.length > 0) {
                const sum = grades.reduce((a, b) => a + b.nota, 0);
                avg = (sum / grades.length).toFixed(1);
            }

            // Renderizar KPIs
            document.getElementById('kpiUsers').innerText = usersCount || 0;
            document.getElementById('kpiEvals').innerText = evalsCount || 0;
            document.getElementById('kpiAvg').innerText = avg;
            document.getElementById('kpiIA').innerText = iaCount || 0;

            // 2. Cargar Tablas para Gráficos
            loadCharts(grades);
            loadRecentActivity();
        }

        async function loadCharts(grades) {
            // Preparar datos para Tasa de Aprobación
            let pass = 0, fail = 0;
            if(grades) {
                grades.forEach(g => { if(g.nota >= 14) pass++; else fail++; });
            }

            // Gráfico de Dona (Aprobados vs Reprobados)
            const ctxDoughnut = document.getElementById('doughnutChart').getContext('2d');
            new Chart(ctxDoughnut, {
                type: 'doughnut',
                data: {
                    labels: ['Aprobados', 'Reprobados'],
                    datasets: [{
                        data: [pass, fail],
                        backgroundColor: ['#10b981', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, cutout: '70%' }
            });

            // Gráfico de Barras (Promedio por Grupos - Simulado real query grouping)
            // Nota: Supabase free no soporta "groupby" directo fácil sin funciones RPC, 
            // así que haremos un fetch de usuarios y sus promedios para agrupar en JS.
            const { data: users } = await sbClient.from('usuarios').select('etiqueta, promedio').neq('etiqueta', null);
            
            let groups = {};
            if(users) {
                users.forEach(u => {
                    if(!groups[u.etiqueta]) groups[u.etiqueta] = { sum: 0, count: 0 };
                    groups[u.etiqueta].sum += parseFloat(u.promedio || 0);
                    groups[u.etiqueta].count++;
                });
            }

            let labels = Object.keys(groups);
            let dataPoints = labels.map(l => (groups[l].sum / groups[l].count).toFixed(1));

            const ctxBar = document.getElementById('barChart').getContext('2d');
            new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: labels.length ? labels : ['General'], // Fallback
                    datasets: [{
                        label: 'Promedio de Notas',
                        data: dataPoints.length ? dataPoints : [avg],
                        backgroundColor: '#4f46e5',
                        borderRadius: 5
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, max: 20 } }
                }
            });
        }

        async function loadRecentActivity() {
            const { data: recents } = await sbClient.from('evaluaciones')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(5);

            let h = '';
            if(recents && recents.length > 0) {
                recents.forEach(r => {
                    const status = r.nota >= 14 
                        ? '<span class="badge badge-success">Aprobado</span>' 
                        : '<span class="badge badge-warning">Reprobado</span>';
                    
                    h += `
                    <tr>
                        <td>${new Date(r.created_at).toLocaleDateString()}</td>
                        <td><b>${r.usuario}</b></td>
                        <td>${r.curso}</td>
                        <td>${r.nota}</td>
                        <td>${status}</td>
                    </tr>`;
                });
            } else {
                h = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#999">No hay actividad reciente.</td></tr>';
            }
            document.getElementById('recentActivity').innerHTML = h;
        }
    </script>
</body>
</html>